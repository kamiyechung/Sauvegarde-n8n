{
  "active": false,
  "connections": {
    "Anthropic Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Structured Output Parser",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "MCP Notion": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "MCP Gmail": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "When Executed by Another Workflow": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "AI Agent",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-10-23T13:56:03.559Z",
  "id": "9Fh4se1qBP5Mkg5S",
  "isArchived": false,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "[Gestion des factures] Traitement de la facture AG2",
  "nodes": [
    {
      "parameters": {
        "promptType": "define",
        "text": "=Tu es un assistant spÃ©cialisÃ© en automatisation comptable et intÃ©gration Notion.\n\n---\n\n### ðŸŽ¯ OBJECTIF :\nTu reÃ§ois des donnÃ©es extraites dâ€™un mail et dâ€™un PDF de facture au format JSON.\nTon rÃ´le est de consolider toutes les informations pour prÃ©parer une crÃ©ation complÃ¨te dans la base Notion â€œFacturesâ€.\n\nTu dois :\n1. Identifier le bon **prestataire** (base liÃ©e â€œPrestatairesâ€) et **catÃ©gorie** (base liÃ©e â€œCatÃ©goriesâ€) et fournir leurs IDs.\n2. ComplÃ©ter toutes les autres propriÃ©tÃ©s de la base â€œFacturesâ€ (montants, dates, mode de paiement, frÃ©quence, etc.).\n3. Si une donnÃ©e est absente ou incertaine, laisse `\"null\"`, mais ne crÃ©e pas de texte superflu.\n\n---\n\n### ðŸ”¹ STRUCTURE NOTION :\n- **Base principale :** `Factures`  \n  ðŸ“„ https://www.notion.so/1d402d84a06480dc9457efe180b8d4c0?v=20002d84a06480a4aa7b000cba3240ca  \n  Elle est reliÃ©e Ã  :\n  - **Base â€œPrestatairesâ€**\n  - **Base â€œCatÃ©goriesâ€**\n\nTu dois renvoyer les **IDs Notion** corrects si lâ€™entrÃ©e existe dÃ©jÃ .  \nSi tu nâ€™as pas lâ€™ID, propose un **libellÃ© clair Ã  crÃ©er** dans le champ correspondant (`*_label`).\n\n---\n\n### ðŸ”¹ ENTRÃ‰E :\nVoici les donnÃ©es extraites par lâ€™Agent 1 et le contenu du mail :\n{{ $json }}\n\n---\n\n### ðŸ”¹ INSTRUCTIONS :\n- Combine les informations du mail et du PDF pour obtenir un ensemble complet.  \n- Pour â€œprestataireâ€ et â€œcategorieâ€ :\n  - Si une correspondance connue existe dans les bases Notion, renvoie son ID.  \n  - Sinon, renvoie `\"null\"` pour lâ€™ID et propose un nouveau libellÃ©.\n- Analyse aussi les champs suivants Ã  partir du contenu disponible :\n  - `date_facture`, `date_paiement`\n  - `montant_ht`, `montant_tva`, `montant_ttc`\n  - `mode_paiement`\n  - `taux_tva`\n  - `devise`\n  - `projet`, `frequence`, `paiement_recurrent`\n  - `tags`\n- Harmonise les formats :\n  - Montants numÃ©riques sans symbole (â‚¬)\n  - Dates ISO (`YYYY-MM-DD`)\n  - BoolÃ©ens (`true` / `false`)\n  - Devise = `\"EUR\"` par dÃ©faut si absente\n\n---\n\n### ðŸ”¹ SORTIE ATTENDUE :\nRenvoie **uniquement un objet JSON valide**, sans commentaire ni texte additionnel.\n\nFormat strict attendu :\n{\n  \"prestataire_id\": \"\",\n  \"prestataire_label\": \"\",\n  \"categorie_id\": \"\",\n  \"categorie_label\": \"\",\n  \"type_depense\": \"\",\n  \"projet\": \"\",\n  \"frequence\": \"\",\n  \"paiement_recurrent\": \"\",\n  \"date_facture\": \"\",\n  \"date_paiement\": \"\",\n  \"montant_ht\": \"\",\n  \"montant_tva\": \"\",\n  \"montant_ttc\": \"\",\n  \"taux_tva\": \"\",\n  \"mode_paiement\": \"\",\n  \"devise\": \"\",\n  \"objet\": \"\",\n  \"tags\": []\n}\n\n---\n\n### ðŸ”¹ EXEMPLE :\n**EntrÃ©e :**\n{\n  \"mail_text\": \"Bonjour, voici la facture dâ€™octobre pour lâ€™abonnement Google Workspace. Montant TTC : 12â‚¬.\",\n  \"fournisseur_nom\": \"Google\",\n  \"date_facture\": \"2025-10-01\",\n  \"montant_ttc\": \"12.00\"\n}\n\n**Sortie :**\n{\n  \"prestataire_id\": \"b4b0b84a-a064-80a4-b52b-fd6d9ecb1122\",\n  \"prestataire_label\": \"Google\",\n  \"categorie_id\": \"c2e2d84a-a064-80c0-a34f-b87a112bc001\",\n  \"categorie_label\": \"Abonnements logiciels\",\n  \"type_depense\": \"Charges externes\",\n  \"projet\": \"Checkin Trust\",\n  \"frequence\": \"mensuelle\",\n  \"paiement_recurrent\": true,\n  \"date_facture\": \"2025-10-01\",\n  \"date_paiement\": null,\n  \"montant_ht\": \"10.00\",\n  \"montant_tva\": \"2.00\",\n  \"montant_ttc\": \"12.00\",\n  \"taux_tva\": \"20\",\n  \"mode_paiement\": \"PrÃ©lÃ¨vement\",\n  \"devise\": \"EUR\",\n  \"objet\": \"Abonnement Google Workspace\",\n  \"tags\": [\"Google\", \"Abonnement\", \"Logiciel\"]\n}",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "You are a helpful assistant"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        672,
        -272
      ],
      "id": "839db464-af31-4f8d-93ce-06e687ea6af6",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "claude-3-haiku-20240307",
          "mode": "list",
          "cachedResultName": "Claude Haiku 3"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatAnthropic",
      "typeVersion": 1.3,
      "position": [
        496,
        -16
      ],
      "id": "a360169e-6aad-449f-9b43-a6bf66455182",
      "name": "Anthropic Chat Model",
      "credentials": {
        "anthropicApi": {
          "id": "ZbZl90Lb8InIiwYE",
          "name": "Anthropic account"
        }
      }
    },
    {
      "parameters": {
        "endpointUrl": "http://195.201.118.139:3001/mcp/notion",
        "serverTransport": "httpStreamable",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.mcpClientTool",
      "typeVersion": 1.1,
      "position": [
        768,
        -16
      ],
      "id": "6077bf1a-c2da-429d-9189-2bed114dc3cc",
      "name": "MCP Notion"
    },
    {
      "parameters": {
        "endpointUrl": "http://195.201.118.139:3004/mcp/gmail",
        "serverTransport": "httpStreamable",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.mcpClientTool",
      "typeVersion": 1.1,
      "position": [
        928,
        -16
      ],
      "id": "1529c553-3ed3-43a0-b068-ca785515a292",
      "name": "MCP Gmail"
    },
    {
      "parameters": {
        "inputSource": "passthrough"
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        480,
        -256
      ],
      "id": "37461c50-9a31-4c8c-80fc-474bf226c169",
      "name": "When Executed by Another Workflow"
    },
    {
      "parameters": {
        "jsonSchemaExample": "const raw = $json[\"text\"] ?? $json[\"response\"] ?? $input.first().json[\"text\"] ?? \"{}\";\n\ntry {\n  const jsonMatch = raw.match(/{[\\s\\S]*}/);\n  if (!jsonMatch) throw new Error(\"No JSON found in response\");\n\n  const parsed = JSON.parse(jsonMatch[0]);\n\n  const expectedKeys = [\n    \"prestataire_id\",\n    \"prestataire_label\",\n    \"categorie_id\",\n    \"categorie_label\",\n    \"type_depense\",\n    \"projet\",\n    \"frequence\",\n    \"paiement_recurrent\",\n    \"date_facture\",\n    \"date_paiement\",\n    \"montant_ht\",\n    \"montant_tva\",\n    \"montant_ttc\",\n    \"taux_tva\",\n    \"mode_paiement\",\n    \"devise\",\n    \"objet\",\n    \"tags\"\n  ];\n\n  expectedKeys.forEach(k => {\n    if (!(k in parsed)) parsed[k] = null;\n  });\n\n  return parsed;\n\n} catch (err) {\n  return {\n    error: \"JSON parsing failed\",\n    raw_output: raw,\n    message: err.message\n  };\n}",
        "autoFix": true
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        1040,
        -48
      ],
      "id": "45d092ad-b00a-4467-a45b-c5ee4a2a5a15",
      "name": "Structured Output Parser"
    }
  ],
  "origin": "n8n",
  "pinData": {},
  "repo": {
    "owner": "kamiyechung",
    "name": "Sauvegarde-n8n"
  },
  "settings": {
    "executionOrder": "v1"
  },
  "shared": [
    {
      "createdAt": "2025-10-23T13:56:03.559Z",
      "updatedAt": "2025-10-23T13:56:03.559Z",
      "role": "workflow:owner",
      "workflowId": "9Fh4se1qBP5Mkg5S",
      "projectId": "oALk376RbKlV8lOt"
    }
  ],
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2025-10-23T15:09:21.626Z",
  "versionId": "36b8f34b-b2f8-45bd-805e-98757ab6be40"
}